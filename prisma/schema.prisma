datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum GlobalRole {
  SUPER_ADMIN
}

enum OrgRole {
  OWNER
  ADMIN
  PM
  MEMBER
  CLIENT
}

enum ProjectStatus {
  PLANNED
  ONGOING
  ON_HOLD
  COMPLETED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model User {
  id         String      @id @default(cuid())
  name       String
  email      String      @unique
  password   String
  avatarUrl  String?
  isActive   Boolean     @default(true)
  globalRole GlobalRole?

  // üîê SECURITY
  failedLoginCount Int       @default(0)
  lockedUntil      DateTime?

  sessions Session[]
  orgUsers OrganizationUser[]
  projectMembers ProjectMember[]

  comments            TaskComment[]
  timeEntries         TimeEntry[]
  notifications       Notification[]
  passwordResetTokens PasswordResetToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tasks     Task[]
}


model Session {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  activeOrgId String?
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

model Organization {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  logoUrl       String?
  timezone      String   @default("Asia/Jakarta")
  isActive      Boolean  @default(true)

  // === RETENTION POLICY ===
  retentionDays Int      @default(30) 
  // 30 / 90 hari untuk auto hard-delete data soft-deleted

  // === RELATIONS ===
  members       OrganizationUser[]
  clients       Client[]
  projects      Project[]
  tasks         Task[]
  modules       OrganizationModule[]
  auditLogs     AuditLog[]

  // === METADATA ===
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}


model OrganizationUser {
  id             String  @id @default(cuid())
  organizationId String
  userId         String
  role           OrgRole @default(MEMBER)
  isActive       Boolean @default(true)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model Client {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  email          String // üî• WAJIB, bukan String?
  phone          String?
  company        String?
  notes          String?
  deletedAt      DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects     Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, email])
  @@index([organizationId])
}

model Project {
  id             String        @id @default(cuid())
  organizationId String
  clientId       String?
  name           String
  description    String?
  status         ProjectStatus @default(PLANNED)
  startDate      DateTime?
  dueDate        DateTime?

   // ‚úÖ SOFT DELETE
  deletedAt      DateTime?
  deletedById    String?

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?         @relation(fields: [clientId], references: [id], onDelete: SetNull)
  members      ProjectMember[]
  tasks        Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([clientId])
}

model ProjectMember {
  id        String  @id @default(cuid())
  projectId String
  userId    String
  role      OrgRole @default(MEMBER) // PM / MEMBER

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Task {
  id             String       @id @default(cuid())
  organizationId String
  projectId      String
  title          String
  description    String?
  status         TaskStatus   @default(TODO)
  priority       TaskPriority @default(MEDIUM)
  dueDate        DateTime?
  assigneeId     String?

   // ‚úÖ SOFT DELETE
  deletedAt      DateTime?
  deletedById    String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee     User?        @relation(fields: [assigneeId], references: [id], onDelete: SetNull)

  subtasks    Subtask[]
  comments    TaskComment[]
  attachments TaskAttachment[]
  timeEntries TimeEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([projectId])
  @@index([assigneeId])
}

model Subtask {
  id     String  @id @default(cuid())
  taskId String
  title  String
  isDone Boolean @default(false)

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
}

model TaskComment {
  id      String @id @default(cuid())
  taskId  String
  userId  String
  content String

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([taskId])
  @@index([userId])
}

model TaskAttachment {
  id     String @id @default(cuid())
  taskId String
  title  String
  url    String

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([taskId])
}

model TimeEntry {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  minutes   Int
  note      String?
  entryDate DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([taskId])
  @@index([userId])
}

model Notification {
  id             String  @id @default(cuid())
  organizationId String
  userId         String
  title          String
  body           String?
  href           String?
  readAt         DateTime? 
  isRead         Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([organizationId, userId])
}

model Module {
  id                  String               @id @default(cuid())
  key                 String               @unique
  name                String
  organizationModules OrganizationModule[]
}

model OrganizationModule {
  id             String  @id @default(cuid())
  organizationId String
  moduleId       String
  isEnabled      Boolean @default(true)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  module       Module       @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([organizationId, moduleId])
  @@index([organizationId])
}

model InviteToken {
  id             String   @id @default(cuid())
  organizationId String
  email          String
  role           OrgRole  @default(MEMBER)
  token          String   @unique
  expiresAt      DateTime
  createdAt      DateTime @default(now())
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id             String   @id @default(cuid())
  organizationId String

  actorUserId    String?
  actorName      String?
  actorRole      String?

  action         String
  entityType     String
  entityId       String?

  summary        String
  meta           Json?

  severity       String   @default("INFO")
  source         String   @default("API")

  ip             String?
  userAgent      String?
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([actorUserId, createdAt])
  @@index([action, createdAt])
}

